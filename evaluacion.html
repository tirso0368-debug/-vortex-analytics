<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VORTEX | Evaluación Estratégica</title>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#0f1117;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.container{
  width:90%;
  max-width:600px;
  background:#1a1d26;
  padding:30px;
  border-radius:20px;
  box-shadow:0 0 40px rgba(0,255,200,0.15);
  text-align:center;
}

h1{
  margin-bottom:20px;
  font-size:22px;
}

.question{
  margin:20px 0;
}

button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:bold;
  transition:0.2s;
}

.option{
  background:#252a36;
  color:white;
}

.option:hover{
  background:#00ffc8;
  color:black;
}

.hidden{
  display:none;
}

.loader{
  font-size:18px;
  animation:pulse 1.5s infinite;
}

@keyframes pulse{
  0%{opacity:0.4;}
  50%{opacity:1;}
  100%{opacity:0.4;}
}
</style>
</head>

<body>

<div class="container">

  <div id="loadingScreen">
    <div class="loader">Analizando perfil estratégico...</div>
  </div>

  <div id="quizScreen" class="hidden">
    <h1 id="questionText"></h1>
    <div id="optionsContainer"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCSa3xZ2iKtvnPaXeNQMluaoa27iiOEyeM",
  authDomain: "vortex-app-c8b00.firebaseapp.com",
  projectId: "vortex-app-c8b00",
  storageBucket: "vortex-app-c8b00.firebasestorage.app",
  messagingSenderId: "174144803653",
  appId: "1:174144803653:web:eeb421bd5770ee1f69a42c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.href="login.html";
  }else{
    currentUser = user;
    const ref = doc(db,"users",user.uid);
    const snap = await getDoc(ref);

    if(snap.exists() && snap.data().evaluationCompleted){
      window.location.href="analisisdashboard.html";
    }else{
      startQuiz();
    }
  }
});

const questions = [
  {
    text:"Cuando enfrentas un reto académico, tú:",
    options:[
      {text:"Analizo profundamente antes de actuar",type:"Analítico"},
      {text:"Actúo rápido y ajusto después",type:"Ejecutor"},
      {text:"Busco apoyo y colaboro",type:"Colaborativo"}
    ]
  },
  {
    text:"Tu mayor fortaleza es:",
    options:[
      {text:"Estrategia y lógica",type:"Analítico"},
      {text:"Acción y disciplina",type:"Ejecutor"},
      {text:"Empatía y comunicación",type:"Colaborativo"}
    ]
  },
  {
    text:"Prefieres trabajar:",
    options:[
      {text:"Solo y concentrado",type:"Analítico"},
      {text:"Con objetivos claros y presión",type:"Ejecutor"},
      {text:"En equipo",type:"Colaborativo"}
    ]
  }
];

let currentQuestion = 0;
let respuestas = [];
let scores = {Analítico:0,Ejecutor:0,Colaborativo:0};

function startQuiz(){
  document.getElementById("loadingScreen").classList.add("hidden");
  document.getElementById("quizScreen").classList.remove("hidden");
  showQuestion();
}

function showQuestion(){
  const q = questions[currentQuestion];
  document.getElementById("questionText").innerText = q.text;

  const container = document.getElementById("optionsContainer");
  container.innerHTML="";

  q.options.forEach(option=>{
    const btn = document.createElement("button");
    btn.className="option";
    btn.innerText=option.text;
    btn.onclick=()=>{
      respuestas.push(option.text);
      scores[option.type]++;
      nextQuestion();
    };
    container.appendChild(btn);
  });
}

function nextQuestion(){
  currentQuestion++;
  if(currentQuestion<questions.length){
    showQuestion();
  }else{
    finishQuiz();
  }
}

async function finishQuiz(){
  document.getElementById("quizScreen").classList.add("hidden");
  document.getElementById("loadingScreen").classList.remove("hidden");

  let perfilFinal = Object.keys(scores).reduce((a,b)=>scores[a]>scores[b]?a:b);

  const ref = doc(db,"users",currentUser.uid);

  await setDoc(ref,{
    email:currentUser.email,
    evaluationCompleted:true,
    evaluation:{
      answers:respuestas,
      scores:scores,
      profile:perfilFinal,
      timestamp:new Date()
    }
  },{merge:true});

  setTimeout(()=>{
    window.location.href="analisisdashboard.html";
  },2000);
}

</script>

</body>
</html>
